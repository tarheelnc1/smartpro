<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartPro - Document Generator v5.6</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        /* Show two columns only when preview is visible on desktop */
        @media (min-width: 1024px) {
            .container.show-preview {
                grid-template-columns: 1fr 1fr;
            }
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        /* Hide preview by default */
        #previewPanel {
            display: none;
        }
        
        /* Show preview when visible class is added */
        #previewPanel.visible {
            display: block;
        }
        
        /* Toggle preview button (desktop only) */
        .toggle-preview-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: none;
        }
        
        @media (min-width: 1024px) {
            .toggle-preview-btn {
                display: block;
            }
        }
        
        /* Responsive messaging helpers */
        .mobile-only {
            display: block;
        }
        
        .desktop-only {
            display: none;
        }
        
        @media (min-width: 1024px) {
            .mobile-only {
                display: none;
            }
            
            .desktop-only {
                display: block;
            }
        }

        h1, h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .section-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
        }

        .line-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }

        .line-item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        .preview {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-family: Arial, sans-serif;
            font-size: 10pt;
            min-height: 500px;
        }

        .preview table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border: 2px solid #333;
        }

        .preview th,
        .preview td {
            padding: 10px 8px;
            text-align: left;
            border-right: 1px solid #999;
            font-size: 10pt;
        }
        
        /* All columns use Arial 10pt */
        .preview th:nth-child(2),
        .preview th:nth-child(3),
        .preview th:nth-child(4),
        .preview td:nth-child(2),
        .preview td:nth-child(3),
        .preview td:nth-child(4) {
            font-size: 10pt;
        }
        
        .preview th:last-child,
        .preview td:last-child {
            border-right: none;
        }

        .preview th {
            background: white;
            font-weight: bold;
            text-align: right;
            border-bottom: 2px solid #333;
        }

        .preview th:first-child {
            text-align: left;
        }

        .preview td {
            text-align: right;
        }

        .preview td:first-child {
            text-align: left;
            padding-left: 10px;  /* Simple padding, no hanging indent */
            text-indent: 0;  /* No indent */
        }
        
        .section-header td:first-child {
            padding-left: 10px;
            text-indent: 0;
        }

        .section-header {
            background: #d3d3d3 !important;
            font-weight: bold;
            border-bottom: 1px solid #999 !important;
        }
        
        .section-header td {
            border-bottom: 1px solid #999 !important;
        }

        .invoice-total-row {
            background: #999999 !important;
            color: white;
            font-weight: bold;
            border-top: 2px solid #333 !important;
            border-bottom: 2px solid #333 !important;
        }
        
        /* Invoice table - clean design with no vertical borders */
        .preview table.invoice-table {
            border: none !important;
        }
        
        .preview table.invoice-table th,
        .preview table.invoice-table td {
            border-left: none !important;
            border-right: none !important;
        }
        
        .preview table.invoice-table th {
            border-bottom: none !important;
        }
        
        .invoice-total-row td {
            border-top: 2px solid #333 !important;
            border-bottom: 2px solid #333 !important;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <div class="panel">
            <h2>SmartPro Document Generator v5.6</h2>
            <div id="inputContainer"></div>
        </div>

        <div class="panel" id="previewPanel">
            <h2>Preview</h2>
            <div id="preview" class="preview"></div>
        </div>
    </div>
    
    <!-- Toggle preview button (desktop only) -->
    <button class="btn btn-secondary toggle-preview-btn" id="togglePreviewBtn" onclick="togglePreview()" style="display: none;">
        üëÅÔ∏è Toggle Preview
    </button>

    <script>
        // Proposal data structure with line items
        const proposalData = {
            documentType: 'invoice', // 'invoice', 'proposal', or 'change_order'
            proposalTitle: '',
            date: '',
            client: '',
            address: '',
            sections: [], // Each section: { name: "Painting", material: 0, labor: 0, lineItems: [{description, material, labor, total}] }
            dumpsterFee: 0,
            permitFee: 0,
            gcFee: 0,
            notes: '',
            paymentPlan: [
                { label: 'Down Payment', percent: 50 },
                { label: 'Final Payment', percent: 50 }
            ],
            isPaid: false
        };

        // Invoice data (simpler structure than proposals)
        const invoiceData = {
            date: '',
            client: '',
            invoiceNumber: '',
            lineItems: [], // {description, amount}
            isPaid: false
        };

        let currentStep = 1;
        let currentEditingSection = -1;
        let currentEditingLineItem = -1;
        let previewVisible = false;

        // Company info
        const companyInfo = {
            name: 'D GISS Construction II LLC',
            address1: '43 Warner Ave',
            address2: 'West Haven, CT 06516',
            phone: '(203) 997-6542',
            hic: 'HIC# 0663546'
        };
        
        // Functions to show/hide preview
        function showPreview() {
            previewVisible = true;
            document.getElementById('previewPanel').classList.add('visible');
            document.getElementById('mainContainer').classList.add('show-preview');
            const btn = document.getElementById('togglePreviewBtn');
            if (btn) btn.style.display = 'none'; // Hide toggle button in review mode
            updatePreview();
        }
        
        function hidePreview() {
            previewVisible = false;
            document.getElementById('previewPanel').classList.remove('visible');
            document.getElementById('mainContainer').classList.remove('show-preview');
            const btn = document.getElementById('togglePreviewBtn');
            if (btn) btn.style.display = 'block'; // Show toggle button when not in review
        }
        
        function togglePreview() {
            if (previewVisible) {
                hidePreview();
            } else {
                showPreview();
            }
        }

        // Save and Load Functions
        function saveDraft() {
            // Check if this is an invoice or proposal
            if (proposalData.documentType === 'invoice') {
                // Save invoice using invoice-specific function
                saveInvoiceDraft();
            } else {
                // Save proposal
                const draftName = prompt("Enter a name for this draft:", proposalData.proposalTitle || proposalData.client || "Untitled Draft");
                if (!draftName) return;
                
                const draft = {
                    name: draftName,
                    date: new Date().toISOString(),
                    data: JSON.parse(JSON.stringify(proposalData)) // Deep copy
                };
                
                // Get existing drafts
                const drafts = JSON.parse(localStorage.getItem('smartProDrafts') || '[]');
                
                // Add new draft
                drafts.push(draft);
                
                // Save to localStorage
                localStorage.setItem('smartProDrafts', JSON.stringify(drafts));
                
                alert(`‚úÖ Draft "${draftName}" saved successfully!`);
            }
        }
        
        function showSavedDrafts() {
            const drafts = JSON.parse(localStorage.getItem('smartProDrafts') || '[]');
            
            if (drafts.length === 0) {
                alert('No saved drafts found.');
                return;
            }
            
            document.getElementById('inputContainer').innerHTML = `
                <h3>üìÅ Saved Drafts</h3>
                
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <p style="margin: 0;">Select a draft to load and continue editing.</p>
                </div>
                
                <div id="draftsList" style="margin: 15px 0;">
                    ${drafts.map((draft, index) => {
                        const date = new Date(draft.date);
                        const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                        return `
                            <div class="section-item" style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0; padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                                <div style="flex: 1;">
                                    <strong style="font-size: 1.1em;">${draft.name}</strong>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">Saved: ${formattedDate}</p>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9em;">Client: ${draft.data.client || '[Not set]'}</p>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-primary" onclick="loadDraft(${index})">üìÇ Load</button>
                                    <button class="btn btn-danger" onclick="deleteDraft(${index})">üóëÔ∏è Delete</button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="showBasicInfo()">‚Üê Start New Document</button>
                </div>
            `;
        }
        
        function loadDraft(index) {
            const drafts = JSON.parse(localStorage.getItem('smartProDrafts') || '[]');
            
            if (index >= 0 && index < drafts.length) {
                const draft = drafts[index];
                
                // Load data into proposalData
                Object.assign(proposalData, draft.data);
                
                alert(`‚úÖ Draft "${draft.name}" loaded!`);
                
                // Go to basic info screen to continue editing
                showBasicInfo();
            }
        }
        
        function deleteDraft(index) {
            const drafts = JSON.parse(localStorage.getItem('smartProDrafts') || '[]');
            
            if (index >= 0 && index < drafts.length) {
                const draft = drafts[index];
                
                if (confirm(`Delete draft "${draft.name}"?`)) {
                    drafts.splice(index, 1);
                    localStorage.setItem('smartProDrafts', JSON.stringify(drafts));
                    showSavedDrafts(); // Refresh the list
                }
            }
        }

        // Start with document type selection
        showDocumentTypeSelection();
        
        function showDocumentTypeSelection() {
            hidePreview();
            document.getElementById('inputContainer').innerHTML = `
                <h3>Select Document Type</h3>
                
                <div style="display: flex; flex-direction: column; gap: 15px; max-width: 400px; margin: 20px auto;">
                    <button class="btn btn-primary" onclick="selectDocumentType('invoice')" style="padding: 20px; font-size: 1.2em;">
                        üìã Invoice
                    </button>
                    <button class="btn btn-primary" onclick="selectDocumentType('proposal')" style="padding: 20px; font-size: 1.2em;">
                        üìÑ Proposal
                    </button>
                    <button class="btn btn-primary" onclick="selectDocumentType('change_order')" style="padding: 20px; font-size: 1.2em;">
                        üîÑ Change Order
                    </button>
                </div>
            `;
        }
        
        function selectDocumentType(type) {
            proposalData.documentType = type;
            
            if (type === 'invoice') {
                // Invoice has its own simpler workflow
                showInvoiceStep(1);
            } else {
                // Proposal, Change Order use the full workflow
                showBasicInfo();
            }
        }
        
        // ============================================
        // INVOICE NUMBERING (per client)
        // ============================================
        
        function getInvoiceNumbers() {
            return JSON.parse(localStorage.getItem('invoiceNumbers') || '{}');
        }

        function getNextInvoiceNumber(client) {
            const invoiceNumbers = getInvoiceNumbers();
            const currentNumber = invoiceNumbers[client] || 0;
            const nextNumber = currentNumber + 1;
            return String(nextNumber).padStart(3, '0');
        }

        function saveInvoiceNumber(client, number) {
            const invoiceNumbers = getInvoiceNumbers();
            invoiceNumbers[client] = parseInt(number);
            localStorage.setItem('invoiceNumbers', JSON.stringify(invoiceNumbers));
        }
        
        function updateClientAndNumber() {
            const client = document.getElementById('invoiceClient').value;
            if (client) {
                const nextNumber = getNextInvoiceNumber(client);
                document.getElementById('invoiceNumber').value = nextNumber;
                invoiceData.client = client;
                invoiceData.invoiceNumber = nextNumber;
            }
            updateInvoicePreview();
        }
        
        // ============================================
        // INVOICE SAVE/LOAD FUNCTIONALITY
        // ============================================
        
        function saveInvoiceDraft() {
            if (!invoiceData.client) {
                alert('Please enter a client name before saving');
                return;
            }
            
            const draftName = `Invoice_${invoiceData.invoiceNumber}_${invoiceData.client}`;
            const drafts = JSON.parse(localStorage.getItem('invoiceDrafts') || '{}');
            
            drafts[draftName] = {
                ...invoiceData,
                savedAt: new Date().toISOString()
            };
            
            localStorage.setItem('invoiceDrafts', JSON.stringify(drafts));
            alert(`‚úÖ Invoice saved as: ${draftName}`);
        }
        
        function showSavedInvoices() {
            const drafts = JSON.parse(localStorage.getItem('invoiceDrafts') || '{}');
            const draftList = Object.keys(drafts);
            
            if (draftList.length === 0) {
                alert('No saved invoices found.');
                return;
            }
            
            document.getElementById('inputContainer').innerHTML = `
                <h3>üìÅ Saved Invoices</h3>
                
                <div class="section-item">
                    <p>Select an invoice to load and edit:</p>
                    
                    ${draftList.map(name => {
                        const draft = drafts[name];
                        const savedDate = new Date(draft.savedAt).toLocaleDateString();
                        return `
                            <div style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 4px; background: #f9f9f9;">
                                <div style="font-weight: bold; margin-bottom: 5px;">${name}</div>
                                <div style="font-size: 0.9em; color: #666;">
                                    Client: ${draft.client} | 
                                    Invoice #${draft.invoiceNumber} | 
                                    Items: ${draft.lineItems.length} | 
                                    Saved: ${savedDate}
                                </div>
                                <div style="margin-top: 10px;">
                                    <button class="btn btn-primary" onclick="loadInvoiceDraft('${name}')" style="margin-right: 10px;">
                                        üìÇ Load
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteInvoiceDraft('${name}')">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                    
                    <div class="button-group" style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="showInvoiceStep(1)">‚Üê Back</button>
                    </div>
                </div>
            `;
        }
        
        function loadInvoiceDraft(draftName) {
            const drafts = JSON.parse(localStorage.getItem('invoiceDrafts') || '{}');
            const draft = drafts[draftName];
            
            if (!draft) {
                alert('Draft not found');
                return;
            }
            
            // Load draft data
            invoiceData.date = draft.date;
            invoiceData.client = draft.client;
            invoiceData.invoiceNumber = draft.invoiceNumber;
            invoiceData.lineItems = draft.lineItems || [];
            invoiceData.isPaid = draft.isPaid || false;
            
            // Go to line items screen
            showInvoiceStep(2);
            alert(`‚úÖ Loaded: ${draftName}`);
        }
        
        function deleteInvoiceDraft(draftName) {
            if (!confirm(`Delete invoice: ${draftName}?`)) {
                return;
            }
            
            const drafts = JSON.parse(localStorage.getItem('invoiceDrafts') || '{}');
            delete drafts[draftName];
            localStorage.setItem('invoiceDrafts', JSON.stringify(drafts));
            
            showSavedInvoices(); // Refresh list
        }
        
        // ============================================
        // INVOICE WORKFLOW (Simpler than Proposals)
        // ============================================
        
        function showInvoiceStep(step) {
            // Save current step data before navigating
            if (currentStep === 1) {
                // Save basic info if fields exist
                const dateField = document.getElementById('invoiceDate');
                const clientField = document.getElementById('invoiceClient');
                const numberField = document.getElementById('invoiceNumber');
                
                if (dateField) invoiceData.date = dateField.value;
                if (clientField) invoiceData.client = clientField.value;
                if (numberField) invoiceData.invoiceNumber = numberField.value;
            }
            
            currentStep = step;
            hidePreview();
            
            switch(step) {
                case 1:
                    showInvoiceBasicInfo();
                    break;
                case 2:
                    showInvoiceLineItems();
                    break;
                case 3:
                    showInvoiceReview();
                    break;
            }
        }
        
        function showInvoiceBasicInfo() {
            const today = new Date().toISOString().split('T')[0];
            
            document.getElementById('inputContainer').innerHTML = `
                <h3>Step 1 of 3: Invoice Information</h3>
                
                <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ffc107;">
                    <button class="btn btn-success" onclick="showSavedInvoices()" style="width: 100%;">
                        üìÅ Load Saved Invoice
                    </button>
                </div>
                
                <div class="section-item">
                    <div class="input-group">
                        <label>Invoice Date:</label>
                        <input type="date" id="invoiceDate" value="${invoiceData.date || today}" onchange="updateInvoicePreview()">
                    </div>
                    
                    <div class="input-group">
                        <label>Billed To (Client Name):</label>
                        <input type="text" id="invoiceClient" placeholder="e.g., John Smith" value="${invoiceData.client || ''}" oninput="updateClientAndNumber()">
                    </div>
                    
                    <div class="input-group">
                        <label>Invoice Number:</label>
                        <input type="text" id="invoiceNumber" placeholder="001" value="${invoiceData.invoiceNumber || '001'}" oninput="updateInvoicePreview()">
                        <small style="color: #666;">Auto-suggested based on client, but you can edit it</small>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="showDocumentTypeSelection()">‚Üê Back</button>
                        <button class="btn btn-primary" onclick="saveInvoiceBasicAndNext()">Next: Line Items ‚Üí</button>
                    </div>
                </div>
            `;
            
            // If coming back with existing data, trigger number update
            if (invoiceData.client) {
                updateClientAndNumber();
            }
        }
        
        function saveInvoiceBasicAndNext() {
            invoiceData.date = document.getElementById('invoiceDate').value;
            invoiceData.client = document.getElementById('invoiceClient').value;
            invoiceData.invoiceNumber = document.getElementById('invoiceNumber').value;
            
            if (!invoiceData.client) {
                alert('Please enter a client name');
                return;
            }
            
            if (!invoiceData.invoiceNumber) {
                alert('Please enter an invoice number');
                return;
            }
            
            // Save invoice number to localStorage for this client
            saveInvoiceNumber(invoiceData.client, invoiceData.invoiceNumber);
            
            showInvoiceStep(2);
        }
        
        function showInvoiceLineItems() {
            document.getElementById('inputContainer').innerHTML = `
                <h3>Step 2 of 3: Line Items</h3>
                
                <div class="section-item">
                    <div id="invoiceLineItemsList">
                        ${invoiceData.lineItems.length === 0 ? '<p style="color: #999; font-style: italic;">No line items yet</p>' : ''}
                        ${invoiceData.lineItems.map((item, index) => `
                            <div class="line-item">
                                <div style="flex: 1;">
                                    <strong>${item.description}</strong><br>
                                    <span style="color: #28a745; font-weight: bold;">$${item.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-secondary" onclick="editInvoiceLineItem(${index})" style="padding: 6px 12px;">‚úèÔ∏è</button>
                                    <button class="remove-btn" onclick="removeInvoiceLineItem(${index})">√ó</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <button class="btn btn-success" onclick="addInvoiceLineItem()" style="width: 100%; margin-top: 15px;">
                        + Add Line Item
                    </button>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <strong>Invoice Total: $${invoiceData.lineItems.reduce((sum, item) => sum + item.amount, 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</strong>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="showInvoiceStep(1)">‚Üê Back</button>
                        <button class="btn btn-primary" onclick="showInvoiceStep(3)">Next: Review ‚Üí</button>
                    </div>
                </div>
            `;
        }
        
        function addInvoiceLineItem() {
            document.getElementById('inputContainer').innerHTML = `
                <h3>Step 2 of 3: Add Line Item</h3>
                
                <div class="section-item">
                    <div class="input-group">
                        <label>Description:</label>
                        <textarea id="lineDescription" placeholder="e.g., Final Payment on 4/23 Proposal" rows="3" autofocus style="width: 100%; padding: 10px; font-size: 1em; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                    </div>
                    
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="useVoice" style="width: auto; margin-right: 8px;">
                            Enable voice input for description
                        </label>
                    </div>
                    
                    <div class="input-group">
                        <label>Amount:</label>
                        <input type="number" id="lineAmount" placeholder="0.00" step="0.01" style="width: 100%; padding: 10px; font-size: 1em;">
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="showInvoiceStep(2)">Cancel</button>
                        <button class="btn btn-success" onclick="saveInvoiceLineItem()">Save Line Item</button>
                    </div>
                </div>
            `;
        }
        
        function saveInvoiceLineItem() {
            const description = document.getElementById('lineDescription').value;
            const amount = parseFloat(document.getElementById('lineAmount').value) || 0;
            
            if (!description || !description.trim()) {
                alert('Please enter a description');
                return;
            }
            
            invoiceData.lineItems.push({
                description: description.trim(),
                amount: amount
            });
            
            showInvoiceStep(2);
        }
        
        function editInvoiceLineItem(index) {
            const item = invoiceData.lineItems[index];
            
            document.getElementById('inputContainer').innerHTML = `
                <h3>Step 2 of 3: Edit Line Item</h3>
                
                <div class="section-item">
                    <div class="input-group">
                        <label>Description:</label>
                        <textarea id="lineDescription" rows="3" autofocus style="width: 100%; padding: 10px; font-size: 1em; border: 1px solid #ddd; border-radius: 4px; resize: vertical;">${item.description}</textarea>
                    </div>
                    
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="useVoice" style="width: auto; margin-right: 8px;">
                            Enable voice input for description
                        </label>
                    </div>
                    
                    <div class="input-group">
                        <label>Amount:</label>
                        <input type="number" id="lineAmount" value="${item.amount}" step="0.01" style="width: 100%; padding: 10px; font-size: 1em;">
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="showInvoiceStep(2)">Cancel</button>
                        <button class="btn btn-success" onclick="updateInvoiceLineItem(${index})">Save Changes</button>
                    </div>
                </div>
            `;
        }
        
        function updateInvoiceLineItem(index) {
            const description = document.getElementById('lineDescription').value;
            const amount = parseFloat(document.getElementById('lineAmount').value) || 0;
            
            if (!description || !description.trim()) {
                alert('Please enter a description');
                return;
            }
            
            invoiceData.lineItems[index] = {
                description: description.trim(),
                amount: amount
            };
            
            showInvoiceStep(2);
        }
        
        function removeInvoiceLineItem(index) {
            if (confirm('Remove this line item?')) {
                invoiceData.lineItems.splice(index, 1);
                showInvoiceStep(2);
            }
        }
        
        function showInvoiceReview() {
            showPreview();
            updateInvoicePreview();
            
            document.getElementById('inputContainer').innerHTML = `
                <h3>Step 3 of 3: Review Invoice</h3>
                
                <div class="section-item">
                    <p>Review your invoice on the right. When everything looks good, click "Looks Good!" to proceed to export options.</p>
                    
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="showInvoiceStep(2)">‚Üê Back to Line Items</button>
                        <button class="btn btn-success" onclick="saveAndProceedToExport()">Looks Good! ‚Üí</button>
                    </div>
                </div>
            `;
        }
        
        function saveAndProceedToExport() {
            // Auto-save invoice before proceeding
            saveInvoiceDraft();
            showExportOptions();
        }
        
        function updateInvoicePreview() {
            const preview = document.getElementById('preview');
            const formattedDate = invoiceData.date ? invoiceData.date.replace(/-/g, '/').replace(/(\d{4})\/(\d{2})\/(\d{2})/, '$2/$3/$1') : new Date().toLocaleDateString('en-US');
            const total = invoiceData.lineItems.reduce((sum, item) => sum + item.amount, 0);
            
            preview.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; font-family: Arial, sans-serif;">
                    <div style="text-align: left; font-size: 10.5pt; line-height: 1.8; color: #555;">
                        <div style="font-size: 15pt; font-weight: bold; margin-bottom: 5px; color: #2c3e50;">${companyInfo.name}</div>
                        <div>${companyInfo.address1}</div>
                        <div>${companyInfo.address2}</div>
                        <div>${companyInfo.phone}</div>
                        <div>${companyInfo.hic}</div>
                    </div>
                    <div>
                        <h1 style="font-size: 42pt; font-weight: bold; color: #2c3e50; margin: 0; letter-spacing: 2px;">INVOICE</h1>
                    </div>
                </div>
                
                ${invoiceData.isPaid ? `
                    <div style="text-align: center; margin: 15px 0;">
                        <div style="display: inline-block; border: 4px solid #28a745; padding: 10px 30px; transform: rotate(-5deg); background: rgba(40, 167, 69, 0.1);">
                            <span style="color: #28a745; font-size: 24pt; font-weight: bold; letter-spacing: 3px;">PAID</span>
                        </div>
                    </div>
                ` : ''}
                
                <div style="background: #f5f8fa; border-left: 4px solid #5b9bd5; padding: 20px; margin: 25px 0; font-family: Arial, sans-serif; font-size: 10.5pt;">
                    <div style="display: flex; margin-bottom: 10px;">
                        <div style="width: 140px; font-weight: bold; color: #555;">Bill To:</div>
                        <div style="font-weight: bold; color: #2c3e50;">${invoiceData.client || ''}</div>
                    </div>
                    <div style="display: flex; margin-bottom: 10px;">
                        <div style="width: 140px; font-weight: bold; color: #555;">Invoice Date:</div>
                        <div style="color: #2c3e50;">${formattedDate}</div>
                    </div>
                    <div style="display: flex;">
                        <div style="width: 140px; font-weight: bold; color: #555;">Invoice Number:</div>
                        <div style="color: #2c3e50; font-weight: bold;">#${invoiceData.invoiceNumber || '001'}</div>
                    </div>
                </div>
                
                <table class="invoice-table" style="width: 100%; border-collapse: collapse; margin: 25px 0; font-family: Arial, sans-serif; border: none;">
                    <thead>
                        <tr style="background: #445566; color: white;">
                            <th style="padding: 14px; text-align: left; font-size: 11pt; font-weight: bold; border: none;">Description</th>
                            <th style="padding: 14px; text-align: right; font-size: 11pt; font-weight: bold; width: 150px; border: none;">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${invoiceData.lineItems.map(item => `
                            <tr style="border-bottom: 1px solid #f0f0f0;">
                                <td style="padding: 14px; font-size: 10.5pt; border-left: none; border-right: none;">${item.description}</td>
                                <td style="padding: 14px; text-align: right; font-size: 10.5pt; border-left: none; border-right: none;">$${item.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                            </tr>
                        `).join('')}
                        <tr style="background: white; border-top: 3px solid #445566; border-bottom: 3px solid #445566;">
                            <td style="padding: 16px; font-size: 12pt; font-weight: bold; color: #2c3e50; border-left: none; border-right: none;">TOTAL DUE</td>
                            <td style="padding: 16px; text-align: right; font-size: 12pt; font-weight: bold; color: #2c3e50; border-left: none; border-right: none;">$${total.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                        </tr>
                    </tbody>
                </table>
                
                <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #f0f0f0; font-family: Arial, sans-serif; font-size: 9.5pt; color: #666; line-height: 1.8;">
                    <div style="margin-bottom: 8px;"><span style="font-weight: bold; color: #2c3e50;">Payment Terms:</span> Payment due upon receipt</div>
                    <div>Payments can be made by check unless other arrangements have been made.</div>
                </div>
            `;
        }
        
        // ============================================
        // END INVOICE WORKFLOW
        // ============================================

        function showBasicInfo() {
            hidePreview();
            const today = new Date().toISOString().split('T')[0];
            
            document.getElementById('inputContainer').innerHTML = `
                <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ffc107;">
                    <button class="btn btn-secondary" onclick="showSavedDrafts()" style="width: 100%; margin-bottom: 8px;">
                        üìÅ Load Saved Draft
                    </button>
                    <button class="btn btn-success" onclick="saveDraft()" style="width: 100%;">
                        üíæ Save Current Draft
                    </button>
                </div>
                
                <div class="input-group">
                    <label>Document Type:</label>
                    <select id="documentType" onchange="updatePreview()">
                        <option value="proposal" ${proposalData.documentType === 'proposal' ? 'selected' : ''}>Proposal</option>
                        <option value="quote" ${proposalData.documentType === 'quote' || !proposalData.documentType ? 'selected' : ''}>Quote</option>
                        <option value="changeorder" ${proposalData.documentType === 'changeorder' ? 'selected' : ''}>Change Order</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>Title:</label>
                    <input type="text" id="proposalTitle" placeholder="e.g., Kitchen Renovation, Repairs, Painting" value="${proposalData.proposalTitle || ''}" oninput="updatePreview()">
                </div>
                
                <div class="input-group">
                    <label>Date:</label>
                    <input type="date" id="date" value="${proposalData.date || today}" onchange="updatePreview()">
                </div>
                
                <div class="input-group">
                    <label>Client Name:</label>
                    <input type="text" id="client" placeholder="Client name" value="${proposalData.client || ''}" oninput="updatePreview()">
                </div>
                
                <div class="input-group">
                    <label>Address:</label>
                    <input type="text" id="address" placeholder="Address" value="${proposalData.address || ''}" oninput="updatePreview()">
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="showSections()">Next: Add Work Sections ‚Üí</button>
                </div>
            `;
            
            updatePreview();
        }

        function showSections() {
            saveBasicInfo();
            hidePreview();
            
            document.getElementById('inputContainer').innerHTML = `
                <h3>Work Sections</h3>
                
                <button class="btn btn-success" onclick="saveDraft()" style="width: 100%; margin: 10px 0;">
                    üíæ Save Draft
                </button>
                
                <div id="sectionsList"></div>
                <button class="btn btn-success" onclick="addSection()" style="width: 100%; margin: 10px 0;">+ Add Section</button>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="showBasicInfo()">‚Üê Back</button>
                    <button class="btn btn-primary" onclick="showAdditionalFees()">Next: Additional Fees ‚Üí</button>
                </div>
            `;
            
            renderSections();
        }
        
        function showAdditionalFees() {
            hidePreview();
            
            document.getElementById('inputContainer').innerHTML = `
                <h3>Additional Fees (Optional)</h3>
                
                <button class="btn btn-success" onclick="saveDraft()" style="width: 100%; margin: 10px 0;">
                    üíæ Save Draft
                </button>
                
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <p style="margin: 0;">Add any additional fees to your quote. Leave blank if not needed.</p>
                </div>
                
                <div class="input-group">
                    <label>Dumpster Fee:</label>
                    <input type="number" id="dumpsterFee" placeholder="0.00" value="${proposalData.dumpsterFee || ''}" oninput="saveFees()">
                </div>
                <div class="input-group">
                    <label>Permit Fee:</label>
                    <input type="number" id="permitFee" placeholder="0.00" value="${proposalData.permitFee || ''}" oninput="saveFees()">
                </div>
                <div class="input-group">
                    <label>G.C. Fee:</label>
                    <input type="number" id="gcFee" placeholder="0.00" value="${proposalData.gcFee || ''}" oninput="saveFees()">
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="showSections()">‚Üê Back</button>
                    <button class="btn btn-primary" onclick="showPayment()">Next: Payment ‚Üí</button>
                </div>
            `;
            
            updatePreview();
        }
        
        function saveFees() {
            const dumpsterFeeEl = document.getElementById('dumpsterFee');
            const permitFeeEl = document.getElementById('permitFee');
            const gcFeeEl = document.getElementById('gcFee');
            
            if (dumpsterFeeEl) proposalData.dumpsterFee = parseFloat(dumpsterFeeEl.value) || 0;
            if (permitFeeEl) proposalData.permitFee = parseFloat(permitFeeEl.value) || 0;
            if (gcFeeEl) proposalData.gcFee = parseFloat(gcFeeEl.value) || 0;
            
            updatePreview();
        }

        function renderSections() {
            const container = document.getElementById('sectionsList');
            if (!container) return;
            
            container.innerHTML = proposalData.sections.map((section, sIndex) => {
                const lineItemsTotal = section.lineItems.reduce((sum, item) => sum + item.total, 0);
                const sectionLevelTotal = (section.material || 0) + (section.labor || 0) + (section.sectionTotal || 0);
                const grandTotal = lineItemsTotal + sectionLevelTotal;
                
                return `
                    <div class="section-item">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="color: #b7b7b7; margin: 0;">${section.name}</h4>
                            <div>
                                <button class="btn btn-success" onclick="editSectionCosts(${sIndex})" style="padding: 6px 12px; font-size: 0.9em;">üí∞ Section Costs</button>
                                <button class="btn btn-success" onclick="addLineItem(${sIndex})" style="padding: 6px 12px; font-size: 0.9em;">+ Add Item</button>
                                <button class="btn btn-secondary" onclick="editSectionName(${sIndex})" style="padding: 6px 12px; font-size: 0.9em;">‚úèÔ∏è Edit Name</button>
                                <button class="remove-btn" onclick="removeSection(${sIndex})">√ó</button>
                            </div>
                        </div>
                        
                        ${sectionLevelTotal > 0 ? `
                            <div style="background: #e8f5e9; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                                <strong>Section-Level Costs:</strong><br>
                                ${section.costOption === 1 ? `
                                    Total Only: <strong>$${(section.sectionTotal || 0).toFixed(2)}</strong>
                                ` : `
                                    Material: ${section.material > 0 ? '$' + section.material.toFixed(2) : '-'} | 
                                    Labor: ${section.labor > 0 ? '$' + section.labor.toFixed(2) : '-'} | 
                                    Subtotal: <strong>$${sectionLevelTotal.toFixed(2)}</strong>
                                `}
                            </div>
                        ` : ''}
                        
                        ${section.lineItems.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <div style="font-size: 0.9em; font-weight: bold; margin-bottom: 5px; color: #666;">Line Items:</div>
                                ${section.lineItems.map((item, iIndex) => `
                                    <div class="line-item">
                                        <div class="line-item-row">
                                            <div>‚Ä¢ ${item.description}</div>
                                            <div style="text-align: right;">${item.material > 0 ? '$' + item.material.toFixed(2) : '-'}</div>
                                            <div style="text-align: right;">${item.labor > 0 ? '$' + item.labor.toFixed(2) : '-'}</div>
                                            <div style="text-align: right;"><strong>$${item.total.toFixed(2)}</strong></div>
                                            <div>
                                                <button class="btn btn-secondary" onclick="editLineItem(${sIndex}, ${iIndex})" style="padding: 4px 8px; font-size: 0.85em;">‚úèÔ∏è</button>
                                                <button class="remove-btn" onclick="removeLineItem(${sIndex}, ${iIndex})" style="width: 25px; height: 25px;">√ó</button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                                <div style="text-align: right; margin-top: 5px; font-weight: normal; color: #666; font-size: 0.9em;">
                                    Line Items Subtotal: $${lineItemsTotal.toFixed(2)}
                                </div>
                            </div>
                        ` : '<p style="color: #999; font-style: italic; margin: 10px 0;">No line items yet</p>'}
                        
                        <div style="text-align: right; margin-top: 10px; font-weight: bold; font-size: 1.1em; border-top: 2px solid #ddd; padding-top: 10px;">
                            Section Total: $${grandTotal.toFixed(2)}
                        </div>
                    </div>
                `;
            }).join('');
            
            updatePreview();
        }

        function addSection() {
            const name = prompt("Enter section name (e.g., Painting, Electrical):");
            if (name && name.trim()) {
                proposalData.sections.push({
                    name: name.trim(),
                    material: 0,
                    labor: 0,
                    lineItems: []
                });
                renderSections();
            }
        }

        function editSectionName(sectionIndex) {
            const section = proposalData.sections[sectionIndex];
            const newName = prompt("Edit Section Name:", section.name);
            if (newName && newName.trim()) {
                proposalData.sections[sectionIndex].name = newName.trim();
                renderSections();
            }
        }
        
        function editSectionCosts(sectionIndex) {
            const section = proposalData.sections[sectionIndex];
            
            const costType = prompt("Enter costs as:\n1. Total only\n2. Material and Labor breakdown\n\nEnter 1 or 2:", "1");
            
            if (costType === "1") {
                // Just total
                const currentTotal = section.sectionTotal || (section.material || 0) + (section.labor || 0);
                const total = prompt("Section-level Total cost:", currentTotal);
                if (total === null) return;
                
                const totalNum = parseFloat(total) || 0;
                proposalData.sections[sectionIndex].material = 0;
                proposalData.sections[sectionIndex].labor = 0;
                proposalData.sections[sectionIndex].sectionTotal = totalNum;
                proposalData.sections[sectionIndex].costOption = 1; // Track option
            } else {
                // Material and labor breakdown
                const material = prompt("Section-level Material cost:", section.material || 0);
                if (material === null) return;
                
                const labor = prompt("Section-level Labor cost:", section.labor || 0);
                if (labor === null) return;
                
                proposalData.sections[sectionIndex].material = parseFloat(material) || 0;
                proposalData.sections[sectionIndex].labor = parseFloat(labor) || 0;
                proposalData.sections[sectionIndex].sectionTotal = 0;
                proposalData.sections[sectionIndex].costOption = 2; // Track option
            }
            
            renderSections();
        }

        function removeSection(index) {
            if (confirm('Remove this section and all its items?')) {
                proposalData.sections.splice(index, 1);
                renderSections();
            }
        }

        function addLineItem(sectionIndex) {
            const description = prompt("Item description:");
            if (!description || !description.trim()) return;
            
            const material = parseFloat(prompt("Material cost (enter 0 if none):", "0") || 0);
            const labor = parseFloat(prompt("Labor cost (enter 0 if none):", "0") || 0);
            const total = material + labor;
            
            proposalData.sections[sectionIndex].lineItems.push({
                description: description.trim(),
                material: material,
                labor: labor,
                total: total
            });
            
            renderSections();
        }

        function editLineItem(sectionIndex, itemIndex) {
            const item = proposalData.sections[sectionIndex].lineItems[itemIndex];
            
            const description = prompt("Edit description:", item.description);
            if (!description || !description.trim()) return;
            
            const material = parseFloat(prompt("Material cost:", item.material) || 0);
            const labor = parseFloat(prompt("Labor cost:", item.labor) || 0);
            const total = material + labor;
            
            proposalData.sections[sectionIndex].lineItems[itemIndex] = {
                description: description.trim(),
                material: material,
                labor: labor,
                total: total
            };
            
            renderSections();
        }

        function removeLineItem(sectionIndex, itemIndex) {
            if (confirm('Remove this item?')) {
                proposalData.sections[sectionIndex].lineItems.splice(itemIndex, 1);
                renderSections();
            }
        }

        function saveBasicInfo() {
            const docTypeEl = document.getElementById('documentType');
            const titleEl = document.getElementById('proposalTitle');
            const dateEl = document.getElementById('date');
            const clientEl = document.getElementById('client');
            const addressEl = document.getElementById('address');
            
            if (docTypeEl) proposalData.documentType = docTypeEl.value;
            if (titleEl) proposalData.proposalTitle = titleEl.value;
            if (dateEl) proposalData.date = dateEl.value;
            if (clientEl) proposalData.client = clientEl.value;
            if (addressEl) proposalData.address = addressEl.value;
        }

        function showPayment() {
            saveBasicInfo();
            hidePreview();
            
            document.getElementById('inputContainer').innerHTML = `
                <h3>Payment Plan & Notes</h3>
                
                <button class="btn btn-success" onclick="saveDraft()" style="width: 100%; margin: 10px 0;">
                    üíæ Save Draft
                </button>
                
                <div id="paymentsList"></div>
                
                <button class="btn btn-success" onclick="addPayment()" style="width: 100%; margin: 10px 0;">+ Add Payment</button>
                
                <div id="paymentTotal" style="padding: 10px; background: #f0f0f0; border-radius: 5px; margin: 10px 0; font-weight: bold;"></div>
                
                <div class="input-group">
                    <label>Notes (optional):</label>
                    <textarea id="notes" placeholder="Additional notes...">${proposalData.notes}</textarea>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="showSections()">‚Üê Back</button>
                    <button class="btn btn-primary" onclick="reviewProposal()">Review Proposal/Quote ‚Üí</button>
                </div>
            `;
            
            renderPayments();
            updatePreview();
        }
        
        function renderPayments() {
            const container = document.getElementById('paymentsList');
            if (!container) return;
            
            container.innerHTML = proposalData.paymentPlan.map((payment, index) => `
                <div class="input-group" style="display: flex; gap: 10px; align-items: flex-end;">
                    <div style="flex: 2;">
                        <label>Payment ${index + 1} Label:</label>
                        <input type="text" value="${payment.label}" onchange="updatePaymentLabel(${index}, this.value)" placeholder="e.g., Down Payment">
                    </div>
                    <div style="flex: 1;">
                        <label>Percent (%):</label>
                        <input type="number" value="${payment.percent}" onchange="updatePaymentPercent(${index}, this.value)" min="0" max="100" step="1">
                    </div>
                    <button class="btn btn-danger" onclick="removePayment(${index})" style="padding: 12px 16px;">√ó</button>
                </div>
            `).join('');
            
            updatePaymentTotal();
        }
        
        function updatePaymentLabel(index, label) {
            proposalData.paymentPlan[index].label = label;
            updatePreview();
        }
        
        function updatePaymentPercent(index, percent) {
            proposalData.paymentPlan[index].percent = parseFloat(percent) || 0;
            updatePaymentTotal();
            updatePreview();
        }
        
        function updatePaymentTotal() {
            const total = proposalData.paymentPlan.reduce((sum, p) => sum + p.percent, 0);
            const display = document.getElementById('paymentTotal');
            if (!display) return;
            
            if (total === 100) {
                display.innerHTML = `Total: ${total}% ‚úÖ Perfect!`;
                display.style.background = '#d4edda';
                display.style.color = '#155724';
            } else if (total > 100) {
                display.innerHTML = `Total: ${total}% ‚ö†Ô∏è Over 100%!`;
                display.style.background = '#f8d7da';
                display.style.color = '#721c24';
            } else {
                display.innerHTML = `Total: ${total}% ‚ö†Ô∏è Need ${100 - total}% more`;
                display.style.background = '#fff3cd';
                display.style.color = '#856404';
            }
        }
        
        function addPayment() {
            const remaining = 100 - proposalData.paymentPlan.reduce((sum, p) => sum + p.percent, 0);
            proposalData.paymentPlan.push({
                label: proposalData.paymentPlan.length === 1 ? '2nd Payment' : `Payment ${proposalData.paymentPlan.length + 1}`,
                percent: Math.max(0, remaining)
            });
            renderPayments();
        }
        
        function removePayment(index) {
            if (proposalData.paymentPlan.length <= 1) {
                alert('Must have at least one payment!');
                return;
            }
            proposalData.paymentPlan.splice(index, 1);
            renderPayments();
        }

        function reviewProposal() {
            const notesEl = document.getElementById('notes');
            if (notesEl) proposalData.notes = notesEl.value;
            
            // Check if payment plan equals 100%
            const total = proposalData.paymentPlan.reduce((sum, p) => sum + p.percent, 0);
            if (total !== 100) {
                alert(`Payment plan must equal 100%. Current total: ${total}%`);
                return;
            }
            
            // Show the preview
            showPreview();
            
            document.getElementById('inputContainer').innerHTML = `
                <h3>üìã Review Your ${proposalData.documentType === 'quote' ? 'Quote' : proposalData.documentType === 'proposal' ? 'Proposal' : 'Change Order'}</h3>
                
                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <p style="margin: 0; font-weight: bold;">‚úÖ Document Preview</p>
                    <p style="margin: 5px 0 0 0;">
                        <span class="desktop-only">Review the preview on the right ‚Üí</span>
                        <span class="mobile-only">Scroll down to see the full document below ‚Üì</span>
                    </p>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin: 15px 0;">
                    <h4 style="margin-top: 0;">üìä Document Summary:</h4>
                    <p><strong>Client:</strong> ${proposalData.client || '[Not set]'}</p>
                    <p><strong>Sections:</strong> ${proposalData.sections.length}</p>
                    <p><strong>Total Amount:</strong> $${calculateGrandTotal().toFixed(2)}</p>
                    <p><strong>Payments:</strong> ${proposalData.paymentPlan.length}</p>
                </div>
                
                <div class="button-group" style="flex-direction: column; gap: 15px;">
                    <button class="btn btn-primary" onclick="showExportOptions()" style="width: 100%; font-size: 1.1em; padding: 15px;">
                        ‚úÖ Looks Good - Export Document
                    </button>
                    <button class="btn btn-secondary" onclick="showPayment()" style="width: 100%;">
                        ‚úèÔ∏è Needs Update - Go Back
                    </button>
                </div>
            `;
        }
        
        function calculateGrandTotal() {
            const sectionsTotal = proposalData.sections.reduce((sum, section) => {
                const lineItemsTotal = section.lineItems.reduce((itemSum, item) => itemSum + item.total, 0);
                const sectionLevelTotal = (section.material || 0) + (section.labor || 0) + (section.sectionTotal || 0);
                return sum + lineItemsTotal + sectionLevelTotal;
            }, 0);
            return sectionsTotal + proposalData.dumpsterFee + proposalData.permitFee + proposalData.gcFee;
        }
        
        function showExportOptions() {
            document.getElementById('inputContainer').innerHTML = `
                <h3>üì§ Export Your Document</h3>
                
                <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #28a745;">
                    <p style="margin: 0; color: #155724; font-weight: bold;">‚úÖ Document Ready!</p>
                    <p style="margin: 5px 0 0 0; color: #155724;">Choose how you want to export your ${proposalData.documentType}.</p>
                </div>
                
                <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin: 15px 0; border: 1px solid #ffc107;">
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="loadSavedDocument()" style="flex: 1;">
                            üìÅ Load Saved ${proposalData.documentType === 'invoice' ? 'Invoice' : 'Document'}
                        </button>
                        <button class="btn btn-danger" onclick="startOver()" style="flex: 1;">
                            üîÑ Start Over
                        </button>
                    </div>
                </div>
                
                <div class="section-item" style="margin: 15px 0;">
                    <h4 style="margin-bottom: 15px;">Export Options:</h4>
                    
                    <button class="btn btn-primary" onclick="downloadPDF()" style="width: 100%; margin: 8px 0; padding: 15px; font-size: 1em;">
                        üì• Download as PDF
                    </button>
                    
                    <button class="btn btn-primary" onclick="printPDF()" style="width: 100%; margin: 8px 0; padding: 15px; font-size: 1em;">
                        üñ®Ô∏è Print PDF
                    </button>
                    
                    <button class="btn btn-primary" onclick="saveLocally()" style="width: 100%; margin: 8px 0; padding: 15px; font-size: 1em;">
                        üíæ Save Locally (HTML)
                    </button>
                    
                    <button class="btn btn-success" onclick="saveDraft()" style="width: 100%; margin: 8px 0; padding: 15px; font-size: 1em;">
                        üìÅ Save Draft (Edit Later)
                    </button>
                    
                    <button class="btn btn-primary" onclick="emailInvoice()" style="width: 100%; margin: 8px 0; padding: 15px; font-size: 1em;">
                        üìß Email Invoice
                    </button>
                    
                    <button class="btn btn-primary" onclick="copyForWord()" style="width: 100%; margin: 8px 0; padding: 15px; font-size: 1em;">
                        üìÑ Copy for Word
                    </button>
                    
                    <button class="btn ${(proposalData.documentType === 'invoice' ? invoiceData.isPaid : proposalData.isPaid) ? 'btn-success' : 'btn-secondary'}" onclick="togglePaidStatus()" style="width: 100%; margin: 8px 0; padding: 15px; font-size: 1em;">
                        ${(proposalData.documentType === 'invoice' ? invoiceData.isPaid : proposalData.isPaid) ? '‚úÖ Marked as PAID' : 'üí∞ Mark as Paid'}
                    </button>
                </div>
                
                <div class="button-group" style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="backToReview()">‚Üê Back to Review</button>
                    <button class="btn btn-success" onclick="startNew()">‚ú® Start New Document</button>
                </div>
            `;
        }
        
        function backToReview() {
            // Route to correct review screen based on document type
            if (proposalData.documentType === 'invoice') {
                showInvoiceStep(3);
            } else {
                reviewProposal();
            }
        }
        
        function loadSavedDocument() {
            // Route to correct load screen based on document type
            if (proposalData.documentType === 'invoice') {
                showSavedInvoices();
            } else {
                showSavedDrafts();
            }
        }
        
        function startOver() {
            if (confirm('Start over? This will clear the current document (saved drafts will not be affected).')) {
                // Reset data
                if (proposalData.documentType === 'invoice') {
                    invoiceData.date = '';
                    invoiceData.client = '';
                    invoiceData.invoiceNumber = '';
                    invoiceData.lineItems = [];
                    invoiceData.isPaid = false;
                    showInvoiceStep(1);
                } else {
                    location.reload();
                }
            }
        }
        
        function downloadPDF() {
            const docType = proposalData.documentType;
            const client = (docType === 'invoice') ? invoiceData.client : proposalData.client;
            const invoiceNum = (docType === 'invoice') ? invoiceData.invoiceNumber : '';
            
            // Create filename
            const filename = (docType === 'invoice') 
                ? `Invoice_${invoiceNum}_${client.replace(/\s+/g, '_')}.pdf`
                : `${docType}_${client.replace(/\s+/g, '_')}.pdf`;
            
            // Show loading message
            alert('üìÑ Generating PDF... This may take a moment.');
            
            // Create a temporary container for capturing
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'fixed';
            tempContainer.style.left = '-9999px';
            tempContainer.style.top = '0';
            tempContainer.style.width = '800px';
            tempContainer.style.minWidth = '800px';
            tempContainer.style.maxWidth = '800px';
            tempContainer.style.backgroundColor = '#ffffff';
            tempContainer.style.padding = '20px';
            tempContainer.style.overflow = 'visible';
            tempContainer.style.fontFamily = 'Arial, sans-serif';
            
            // Clone the preview content exactly as is
            tempContainer.innerHTML = document.getElementById('preview').innerHTML;
            document.body.appendChild(tempContainer);
            
            // Wait for content to render
            setTimeout(() => {
                html2canvas(tempContainer, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    width: 800,
                    height: tempContainer.scrollHeight,
                    windowWidth: 800,
                    windowHeight: tempContainer.scrollHeight,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    // Remove temporary container
                    document.body.removeChild(tempContainer);
                    
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'letter');
                    
                    // Letter size dimensions
                    const pageWidth = 215.9;
                    const pageHeight = 279.4;
                    const margin = 12.7; // 0.5 inch margins
                    const contentWidth = pageWidth - (2 * margin);
                    const contentHeight = pageHeight - (2 * margin);
                    
                    // Calculate image dimensions
                    let imgWidth = contentWidth;
                    let imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    // Smart fitting: if close to fitting, scale down to fit on one page
                    if (imgHeight > contentHeight && imgHeight <= contentHeight * 1.30) {
                        const scaleFactor = contentHeight / imgHeight;
                        imgHeight = contentHeight;
                        imgWidth = imgWidth * scaleFactor;
                        const xOffset = (contentWidth - imgWidth) / 2;
                        pdf.addImage(imgData, 'PNG', margin + xOffset, margin, imgWidth, imgHeight);
                    } 
                    else if (imgHeight <= contentHeight) {
                        // Fits on one page
                        pdf.addImage(imgData, 'PNG', margin, margin, imgWidth, imgHeight);
                    } 
                    else {
                        // Multiple pages needed
                        let yPosition = 0;
                        let heightRemaining = imgHeight;
                        
                        pdf.addImage(imgData, 'PNG', margin, margin, imgWidth, imgHeight);
                        heightRemaining -= contentHeight;
                        
                        while (heightRemaining > 0) {
                            yPosition -= contentHeight;
                            pdf.addPage();
                            pdf.addImage(imgData, 'PNG', margin, margin + yPosition, imgWidth, imgHeight);
                            heightRemaining -= contentHeight;
                        }
                    }
                    
                    // Download the PDF
                    pdf.save(filename);
                    alert('‚úÖ PDF Downloaded Successfully!');
                }).catch(error => {
                    // Remove temporary container on error
                    if (document.body.contains(tempContainer)) {
                        document.body.removeChild(tempContainer);
                    }
                    console.error('PDF generation error:', error);
                    alert('Error generating PDF. Please try using Print to PDF instead (Ctrl+P).');
                });
            }, 500); // Wait for render
        }
        
        function printPDF() {
            window.print();
        }
        
        function saveLocally() {
            const html = document.getElementById('preview').innerHTML;
            const blob = new Blob([`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${proposalData.proposalTitle || 'Document'}</title>
                    <style>
                        body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background: white; font-weight: bold; text-align: right; }
                        th:first-child { text-align: left; }
                        td { text-align: right; }
                        td:first-child { text-align: left; }
                        .section-header { background: #d3d3d3; font-weight: bold; }
                        .invoice-total-row { background: #999999; color: white; font-weight: bold; }
                    </style>
                </head>
                <body>${html}</body>
                </html>
            `], { type: 'text/html' });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${proposalData.proposalTitle || 'document'}.html`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ HTML file saved! You can open it in any browser.');
        }
        
        function emailInvoice() {
            const subject = encodeURIComponent(proposalData.proposalTitle || 'Quote/Proposal');
            const body = encodeURIComponent(`Please find attached the ${proposalData.documentType} for ${proposalData.client}.\n\nTotal Amount: $${calculateGrandTotal().toFixed(2)}\n\nThank you!`);
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }
        
        function copyForWord() {
            const preview = document.getElementById('preview');
            const range = document.createRange();
            range.selectNode(preview);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            
            try {
                document.execCommand('copy');
                alert('‚úÖ Content copied! Paste it into Microsoft Word (Ctrl+V or Cmd+V)');
            } catch (err) {
                alert('‚ùå Copy failed. Please manually select and copy the preview.');
            }
            
            window.getSelection().removeAllRanges();
        }
        
        function togglePaidStatus() {
            if (proposalData.documentType === 'invoice') {
                invoiceData.isPaid = !invoiceData.isPaid;
                if (invoiceData.isPaid) {
                    alert('‚úÖ Invoice marked as PAID!');
                } else {
                    alert('Invoice unmarked as paid.');
                }
                updateInvoicePreview();
            } else {
                proposalData.isPaid = !proposalData.isPaid;
                if (proposalData.isPaid) {
                    alert('‚úÖ Document marked as PAID!');
                } else {
                    alert('Document unmarked as paid.');
                }
                updatePreview();
            }
            showExportOptions(); // Refresh the screen to update button
        }
        
        function startNew() {
            if (confirm('Start a new document? Current document will be lost.')) {
                location.reload();
            }
        }

        function updatePreview() {
            const preview = document.getElementById('preview');
            const docTypeLabel = proposalData.documentType === 'invoice' ? 'Invoice' : 
                                 (proposalData.documentType === 'proposal' ? 'Proposal' : 'Change Order');
            const docTitle = proposalData.proposalTitle || `Renovations ${docTypeLabel}`;
            const formattedDate = proposalData.date ? new Date(proposalData.date).toLocaleDateString() : new Date().toLocaleDateString();
            
            // Calculate total including section-level costs
            const sectionsTotal = proposalData.sections.reduce((sum, section) => {
                const lineItemsTotal = section.lineItems.reduce((itemSum, item) => itemSum + item.total, 0);
                const sectionLevelTotal = (section.material || 0) + (section.labor || 0) + (section.sectionTotal || 0);
                return sum + lineItemsTotal + sectionLevelTotal;
            }, 0);
            const invoiceTotal = sectionsTotal + proposalData.dumpsterFee + proposalData.permitFee + proposalData.gcFee;
            
            preview.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #333; font-size: 10pt;">
                    <h3 style="margin: 0; font-size: 11pt; font-weight: normal;">${companyInfo.name}</h3>
                    <p style="margin: 3px 0; font-size: 10pt;">${companyInfo.address1}, ${companyInfo.address2} ${companyInfo.phone}</p>
                </div>
                
                <h1 style="text-align: center; margin: 15px 0; font-size: 12pt; font-weight: bold;">${docTitle}</h1>
                
                ${proposalData.isPaid ? `
                    <div style="text-align: center; margin: 15px 0;">
                        <div style="display: inline-block; border: 4px solid #28a745; padding: 10px 30px; transform: rotate(-5deg); background: rgba(40, 167, 69, 0.1);">
                            <span style="color: #28a745; font-size: 24pt; font-weight: bold; letter-spacing: 3px;">PAID</span>
                        </div>
                    </div>
                ` : ''}
                
                <div style="margin: 15px 0; font-size: 10pt;">
                    <p style="margin: 3px 0;"><strong>Date:</strong> ${formattedDate}</p>
                    <p style="margin: 3px 0;"><strong>Client:</strong> ${proposalData.client || '[Client]'}</p>
                    <p style="margin: 3px 0;"><strong>Address:</strong> ${proposalData.address || '[Address]'}</p>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th style="width: 55%; text-align: left;"></th>
                            <th style="width: 14%; text-align: right;">Material</th>
                            <th style="width: 14%; text-align: right;">Labor</th>
                            <th style="width: 17%; text-align: right;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${proposalData.sections.map(section => {
                            // Calculate sums of all line items
                            const lineItemsMaterialSum = section.lineItems.reduce((sum, item) => sum + (item.material || 0), 0);
                            const lineItemsLaborSum = section.lineItems.reduce((sum, item) => sum + (item.labor || 0), 0);
                            const lineItemsTotal = section.lineItems.reduce((sum, item) => sum + item.total, 0);
                            
                            // Only add section costs to Material/Labor if option 2 was used
                            // If option 1 (total only), add to grand total but not to Material/Labor columns
                            const sectionMaterialForColumn = (section.costOption === 2) ? (section.material || 0) : 0;
                            const sectionLaborForColumn = (section.costOption === 2) ? (section.labor || 0) : 0;
                            const sectionTotalOnly = (section.costOption === 1) ? (section.sectionTotal || 0) : 0;
                            
                            const totalMaterial = lineItemsMaterialSum + sectionMaterialForColumn;
                            const totalLabor = lineItemsLaborSum + sectionLaborForColumn;
                            const grandTotal = lineItemsTotal + sectionMaterialForColumn + sectionLaborForColumn + sectionTotalOnly;
                            
                            return `
                                <tr class="section-header">
                                    <td><strong>${section.name}</strong></td>
                                    <td><strong>${totalMaterial > 0 ? '$ ' + totalMaterial.toLocaleString('en-US', {minimumFractionDigits: 2}) : ''}</strong></td>
                                    <td><strong>${totalLabor > 0 ? '$ ' + totalLabor.toLocaleString('en-US', {minimumFractionDigits: 2}) : ''}</strong></td>
                                    <td><strong>$ ${grandTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></td>
                                </tr>
                                ${section.lineItems.map(item => `
                                    <tr>
                                        <td>${item.description}</td>
                                        <td>${item.material > 0 ? '$ ' + item.material.toLocaleString('en-US', {minimumFractionDigits: 2}) : ''}</td>
                                        <td>${item.labor > 0 ? '$ ' + item.labor.toLocaleString('en-US', {minimumFractionDigits: 2}) : ''}</td>
                                        <td></td>
                                    </tr>
                                `).join('')}
                            `;
                        }).join('')}
                        ${proposalData.dumpsterFee > 0 ? `
                            <tr class="section-header">
                                <td><strong>Dumpster Fee</strong></td>
                                <td></td>
                                <td></td>
                                <td><strong>$ ${proposalData.dumpsterFee.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></td>
                            </tr>
                        ` : ''}
                        ${proposalData.permitFee > 0 ? `
                            <tr class="section-header">
                                <td><strong>Permit Fee</strong></td>
                                <td></td>
                                <td></td>
                                <td><strong>$ ${proposalData.permitFee.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></td>
                            </tr>
                        ` : ''}
                        ${proposalData.gcFee > 0 ? `
                            <tr class="section-header">
                                <td><strong>G.C. Fee</strong></td>
                                <td></td>
                                <td></td>
                                <td><strong>$ ${proposalData.gcFee.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></td>
                            </tr>
                        ` : ''}
                        <tr class="invoice-total-row">
                            <td colspan="3"><strong>Invoice Total: ${formattedDate}</strong></td>
                            <td><strong>$ ${invoiceTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></td>
                        </tr>
                    </tbody>
                </table>
                
                ${proposalData.notes ? `
                    <div style="margin: 20px 0; font-size: 10pt;">
                        <p style="margin: 3px 0;"><strong>Notes:</strong></p>
                        <p style="margin: 3px 0;">${proposalData.notes}</p>
                    </div>
                ` : ''}
                
                <div style="margin: 20px 0; font-size: 10pt;">
                    <p style="margin: 3px 0;"><strong>Payment Plan:</strong></p>
                    <ul style="margin: 5px 0 5px 20px;">
                        ${proposalData.paymentPlan.map(payment => {
                            const amount = invoiceTotal * (payment.percent / 100);
                            return `<li style="margin: 2px 0;">${payment.label}: ${payment.percent}% - $${amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</li>`;
                        }).join('')}
                    </ul>
                    <p style="margin: 3px 0;"><strong>Total due: $${invoiceTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></p>
                </div>
                
                <div style="margin-top: 40px; font-size: 10pt;">
                    <p style="margin: 3px 0;"><strong>Accepted by:</strong></p>
                    <p style="margin: 10px 0 3px 0;"><strong>Client:</strong> ${proposalData.client || '[Client]'} <span style="margin-left: 50px;"><strong>Date:</strong></span></p>
                    <p style="border-top: 2px solid #000; width: 300px; margin: 20px 0;"></p>
                    <p style="margin: 10px 0 3px 0;"><strong>Contractor:</strong> David Gissel <span style="margin-left: 50px;"><strong>Date:</strong></span></p>
                    <p style="border-top: 2px solid #000; width: 300px; margin: 20px 0;"></p>
                </div>
            `;
        }
    </script>
</body>
</html>
